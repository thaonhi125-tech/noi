
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-∆°i | Kh·ªüi ƒë·∫ßu m·ªõi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {"projectId":"noi-56995784-e5526","appId":"1:939165431916:web:3550554f509d48bc8cc049","storageBucket":"noi-56995784-e5526.firebasestorage.app","apiKey":"AIzaSyB8r6XA8OrSlJERUlR6hC2SvdaMmYrv_z8","authDomain":"noi-56995784-e5526.firebaseapp.com","messagingSenderId":"939165431916"};

        // Kh·ªüi t·∫°o Firebase
        const fbApp = initializeApp(firebaseConfig);
        const fbAuth = getAuth(fbApp);
        const fbDb = getFirestore(fbApp);
        const googleProvider = new GoogleAuthProvider();

        // ƒê∆∞a c√°c bi·∫øn ra global scope ƒë·ªÉ app c√≥ th·ªÉ s·ª≠ d·ª•ng
        window.fb = { fbApp, fbAuth, fbDb, googleProvider, onAuthStateChanged, signInWithPopup, collection, getDocs };

        // B·∫Øt ƒë·∫ßu ·ª©ng d·ª•ng sau khi Firebase ƒë√£ s·∫µn s√†ng
        document.dispatchEvent(new CustomEvent('firebase-ready'));
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #F8F7F4;
            --primary-color: #8B5E3C;
            --primary-light: #C4A484;
            --text-color: #333333;
            --white: #FFFFFF;
            --yellow-accent: #FBBF24;
            --yellow-light: #FEF3C7;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.03), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --card-hover-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        body { 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            font-family: 'Be Vietnam Pro', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        .font-sans { font-family: 'Be Vietnam Pro', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .nav-item.active { background-color: var(--yellow-light); color: var(--primary-color); font-weight: 700; }
        #sidebar { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="flex h-dvh overflow-hidden">

    <!-- === SIDEBAR === -->
    <aside id="sidebar" class="absolute md:relative z-50 md:z-auto bg-white w-64 h-full flex-shrink-0 shadow-xl md:shadow-none transform -translate-x-full md:translate-x-0 flex flex-col">
        <div class="p-5 border-b border-gray-100 flex items-center space-x-3">
            <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center font-bold text-amber-800 text-lg">N</div>
            <div><p class="text-sm font-bold" id="sidebar-username">ƒêang t·∫£i...</p><p class="text-xs text-gray-500" id="sidebar-usertitle">H·∫°t gi·ªëng ti·ªÅm nƒÉng</p></div>
        </div>
        <nav class="flex-1 p-3 space-y-2">
            <a href="#" class="nav-item w-full flex items-center space-x-3 p-3 rounded-xl transition-colors duration-200 hover:bg-gray-100" data-tab="home" onclick="app.navigate('home')"><span class="text-xl">üìñ</span><span class="text-sm">H·ªçc T·∫≠p</span></a>
            <a href="#" class="nav-item w-full flex items-center space-x-3 p-3 rounded-xl transition-colors duration-200 hover:bg-gray-100" data-tab="community" onclick="app.navigate('community')"><span class="text-xl">ü§ù</span><span class="text-sm">K·∫øt N·ªëi</span></a>
            <a href="#" class="nav-item w-full flex items-center space-x-3 p-3 rounded-xl transition-colors duration-200 hover:bg-gray-100" data-tab="live" onclick="app.navigate('live')"><span class="text-xl">üì°</span><span class="text-sm">Live Hub</span></a>
            <a href="#" class="nav-item w-full flex items-center space-x-3 p-3 rounded-xl transition-colors duration-200 hover:bg-gray-100" data-tab="profile" onclick="app.navigate('profile')"><span class="text-xl">üë§</span><span class="text-sm">T√¥i</span></a>
        </nav>
    </aside>
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-40 hidden md:hidden" onclick="app.toggleSidebar()"></div>

    <!-- === MAIN CONTENT === -->
    <div id="app-container" class="w-full h-full bg-gray-50 flex items-center justify-center">
        <!-- This will be replaced by either Auth or Main App -->
    </div>
    
    <script type="module">
    const AppTemplate = {
        auth: () => `
            <div id="auth-screen" class="w-full h-full bg-white flex flex-col items-center justify-center p-8 text-center fade-in">
                <div class="w-24 h-24 bg-amber-100 rounded-3xl flex items-center justify-center text-4xl mb-6 border-4 border-white shadow-lg">N</div>
                <h1 class="text-4xl font-bold mb-2 tracking-tight">M·ª´ng b·∫°n v·ªÅ nh√†</h1>
                <p class="text-gray-500 mb-12 max-w-xs leading-relaxed">N∆°i th·∫•u hi·ªÉu ch√≠nh m√¨nh v√† ki·∫øn t·∫°o v·∫≠n m·ªánh c√πng c·ªông ƒë·ªìng NhiLe.</p>
                <button onclick="app.signIn()" class="w-full max-w-sm py-4 rounded-2xl flex items-center justify-center space-x-3 shadow-lg bg-gray-800 text-white font-semibold hover:bg-gray-900 transition-all duration-300 transform hover:scale-105">
                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.67l-3.57-2.77c-1 .67-2.28 1.07-3.71 1.07-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.66l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                    <span>Ti·∫øp t·ª•c v·ªõi Google</span>
                </button>
            </div>
        `,
        main: () => `
            <div id="main-app" class="flex flex-col h-full w-full fade-in">
                <header id="main-header" class="flex-none px-6 pt-6 pb-4 bg-transparent z-10"></header>
                <main id="app-content" class="flex-1 overflow-y-auto no-scrollbar"></main>
            </div>
        `
    };

    const ViewTemplate = {
        _renderHeader(title, isSubPage = false) {
            const backButton = isSubPage
                ? `<button onclick="app.navigate('home')" class="text-3xl p-2 -ml-3 text-gray-500 hover:text-gray-800 transition-colors">‚Äπ</button>`
                : `<button onclick="app.toggleSidebar()" class="md:hidden text-3xl p-2 -ml-2 text-gray-600">‚ò∞</button>`;
            
            return `
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        ${backButton}
                        <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-gray-800">${title}</h1>
                    </div>
                    <div class="flex items-center space-x-2 bg-white rounded-full px-3 py-1.5 shadow-sm border cursor-pointer">
                        <span class="text-yellow-500 text-xl">üèÜ</span>
                        <span class="font-bold text-sm text-gray-700">${app.store.user.trustScore}</span>
                    </div>
                </div>
            `;
        },
        home(container) {
            const header = this._renderHeader('H·ªçc T·∫≠p');
            const currentNode = app.store.roadmap.find(node => node.status === 'current');

            const categoriesHtml = app.store.categories.map(cat => `
                <div onclick="app.navigate('home')" class="bg-white rounded-2xl p-4 flex items-center space-x-4 cursor-pointer transition-transform duration-200 transform hover:-translate-y-1" style="box-shadow: var(--card-shadow);">
                    <span class="text-4xl">${cat.icon || '‚ú®'}</span>
                    <div>
                        <p class="font-bold text-base">${cat.name}</p>
                        <p class="text-xs text-gray-500">${cat.memberCount || 0} th√†nh vi√™n</p>
                    </div>
                </div>`).join('');
            
            const roadmapHtml = app.store.roadmap.map(node => `
                <div onclick="${node.status !== 'locked' ? `app.navigate('course_detail', { courseId: ${node.id} })` : ''}" class="bg-white rounded-2xl p-5 transition-transform duration-200 transform hover:-translate-y-1 ${node.status === 'locked' ? 'opacity-60 cursor-not-allowed' : 'cursor-pointer'}" style="box-shadow: var(--card-shadow);">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xs font-bold text-gray-400 tracking-wider">${node.category.toUpperCase()} &middot; ${node.type.toUpperCase()}</p>
                            <h3 class="font-bold text-lg mt-1 text-gray-800">${node.title}</h3>
                            <p class="text-sm text-gray-500 mt-2">${node.desc}</p>
                        </div>
                        <div class="text-4xl ml-4 pt-1">${node.status === 'locked' ? 'üîí' : (node.status === 'completed' ? '‚úÖ' : '‚ñ∂Ô∏è')}</div>
                    </div>
                </div>`).join('');

            const html = `
                ${header}
                <div class="px-6 py-4 space-y-8">
                    <section>
                        <div class="relative">
                            <input type="text" placeholder="T√¨m ki·∫øm kh√≥a h·ªçc, th·ª≠ th√°ch..." class="w-full bg-white rounded-xl py-4 pl-12 pr-4 shadow-sm border-transparent focus:outline-none focus:ring-2 focus:ring-amber-400 transition"/>
                            <span class="absolute top-1/2 left-4 transform -translate-y-1/2 text-gray-400 text-xl">üîç</span>
                        </div>
                    </section>
                    ${currentNode ? `
                    <section>
                        <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-700">Ti·∫øp t·ª•c h√†nh tr√¨nh</h2></div>
                        <div onclick="app.navigate('course_detail', { courseId: ${currentNode.id} })" class="p-6 rounded-2xl flex items-center border-2 border-amber-300 cursor-pointer bg-amber-50 transition-transform duration-200 transform hover:-translate-y-1" style="box-shadow: var(--card-shadow);">
                            <div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center mr-5 shadow-inner"><span class="text-4xl">${currentNode.icon}</span></div>
                            <div class="flex-grow">
                                <p class="text-xs text-amber-600 font-bold uppercase">ƒêANG H·ªåC - 60%</p>
                                <h3 class="font-bold text-xl text-gray-800 mt-1">${currentNode.title}</h3>
                                <p class="text-sm text-gray-500 mt-1">${currentNode.desc}</p>
                            </div>
                        </div>
                    </section>` : ''}
                    <section>
                        <h2 class="text-xl font-bold mb-4 text-gray-700">Kh√°m ph√° theo ch·ªß ƒë·ªÅ</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${categoriesHtml.length > 0 ? categoriesHtml : '<p class="text-gray-500">ƒêang t·∫£i c√°c c·ªông ƒë·ªìng...</p>'}
                        </div>
                    </section>
                    <section class="pb-20">
                        <h2 class="text-xl font-bold mb-4 text-gray-700">L·ªô tr√¨nh ƒë·ªÅ xu·∫•t</h2>
                        <div class="space-y-4">${roadmapHtml}</div>
                    </section>
                </div>
            `;
            container.innerHTML = html;
        },
        course_detail(container, data) {
            const course = app.store.roadmap.find(c => c.id === data.courseId);
            if (!course) {
                container.innerHTML = this._renderHeader('L·ªói', true) + '<p class="p-6">Kh√¥ng t√¨m th·∫•y kh√≥a h·ªçc.</p>';
                return;
            }
            const header = this._renderHeader(course.title, true);
            const lessonsHtml = (course.lessons || []).map(lesson => `
                <div class="flex items-center justify-between p-4 rounded-xl ${lesson.completed ? 'bg-green-50 text-gray-500' : 'bg-white'} border-2 ${lesson.completed ? 'border-green-100' : 'border-transparent'} transition-all duration-200" style="box-shadow: var(--card-shadow);">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${lesson.completed ? 'bg-green-100' : 'bg-gray-100'} text-lg">${lesson.completed ? '‚úÖ' : '‚ñ∂Ô∏è'}</div>
                        <div>
                            <h4 class="font-bold ${lesson.completed ? 'line-through' : ''}">${lesson.title}</h4>
                        </div>
                    </div>
                </div>
            `).join('');
            const html = `
                ${header}
                <div class="px-6 py-4 space-y-4 pb-20">
                    <div class="bg-white rounded-2xl p-5" style="box-shadow: var(--card-shadow);"><p class="text-gray-600">${course.desc}</p></div>
                    <h3 class="text-xl font-bold text-gray-700 pt-4">N·ªôi dung b√†i h·ªçc</h3>
                    <div class="space-y-3">${lessonsHtml.length > 0 ? lessonsHtml : '<p class="text-gray-500">Ch∆∞a c√≥ b√†i h·ªçc n√†o.</p>'}</div>
                </div>
            `;
            container.innerHTML = html;
        },
        community(container) {
            const header = this._renderHeader('K·∫øt N·ªëi');
            container.innerHTML = `${header}<div class="p-6 text-center text-gray-500"><h3 class="font-bold text-lg mt-10">T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn</h3></div>`;
        },
        live(container) {
            const header = this._renderHeader('Live Hub');
            container.innerHTML = `${header}<div class="p-6 text-center text-gray-500"><h3 class="font-bold text-lg mt-10">T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn</h3></div>`;
        },
        profile(container) {
            const header = this._renderHeader('Trang c√° nh√¢n');
            const user = app.store.user;
            const html = `
                ${header}
                <div class="px-6 py-4 text-center">
                    <img src="${user.avatarUrl}" class="w-32 h-32 rounded-full mx-auto mb-4 shadow-xl border-4 border-white"/>
                    <h2 class="text-2xl font-bold">${user.name}</h2>
                    <p class="text-gray-500">H·∫°t gi·ªëng ti·ªÅm nƒÉng</p>
                    <div class="mt-8 bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="font-bold text-lg mb-4 text-left text-gray-700">Bi·ªÉu ƒë·ªì k·ªπ nƒÉng</h3>
                        <div style="height:300px; width:100%"><canvas id="skillsChart"></canvas></div>
                    </div>
                </div>
            `;
            container.innerHTML = html;
            setTimeout(() => {
                const ctx = document.getElementById('skillsChart')?.getContext('2d');
                if (!ctx) return;
                if(window.mySkillsChart) window.mySkillsChart.destroy();
                window.mySkillsChart = new Chart(ctx, {
                    type: 'radar',
                    data: { labels: ['T√¢m l√Ω', 'L√£nh ƒë·∫°o', 'Kinh doanh', 'ƒê·∫ßu t∆∞', 'S√°ng t·∫°o'], datasets: [{ label: 'K·ªπ nƒÉng', data: [75, 80, 60, 50, 85], backgroundColor: 'rgba(139, 94, 60, 0.2)', borderColor: 'rgba(139, 94, 60, 1)', borderWidth: 2, pointBackgroundColor: 'rgba(139, 94, 60, 1)' }] },
                    options: { maintainAspectRatio: false, scales: { r: { angleLines: { display: false }, suggestedMin: 0, suggestedMax: 100, pointLabels: { font: { size: 14 } }, ticks: { display: false } } }, plugins: { legend: { display: false } } }
                });
            }, 100);
        }
    };

    const app = {
        store: {
            isLoggedIn: false,
            currentView: 'auth',
            currentData: {},
            user: { name: "Guest", trustScore: 0, avatarUrl: '' },
            roadmap: [
                { id: 1, title: "Th·∫•u hi·ªÉu b·∫£n th√¢n", category: "T√¢m l√Ω", type: "Kh√≥a h·ªçc", icon: "üßò‚Äç‚ôÄÔ∏è", status: "completed", desc: "Kh√°m ph√° g·ªëc r·ªÖ c·ªßa suy nghƒ© v√† c·∫£m x√∫c." },
                { id: 2, title: "Qu·∫£n tr·ªã c·∫£m x√∫c", category: "T√¢m l√Ω", type: "Th·ª≠ th√°ch", icon: "‚ù§Ô∏è", status: "current", desc: "L√†m ch·ªß ph·∫£n ·ª©ng tr∆∞·ªõc m·ªçi t√¨nh hu·ªëng.", lessons: [{ title: "B√†i 1: Nh·∫≠n di·ªán c·∫£m x√∫c", completed: true },{ title: "B√†i 2: Ngu·ªìn g·ªëc c·ªßa c·∫£m x√∫c", completed: true },{ title: "B√†i 3: K·ªπ thu·∫≠t 'T·∫°m d·ª´ng'", completed: false },{ title: "B√†i 4: T√°i c·∫•u tr√∫c nh·∫≠n th·ª©c", completed: false },]},
                { id: 3, title: "T∆∞ duy L√£nh ƒë·∫°o", category: "L√£nh ƒë·∫°o", type: "Kh√≥a h·ªçc", icon: "ü¶Å", status: "locked", desc: "X√¢y d·ª±ng t·∫ßm nh√¨n v√† d·∫´n d·∫Øt ƒë·ªôi nh√≥m." },
                { id: 4, title: "AI cho Startup", category: "AI Business", type: "Kh√≥a h·ªçc", icon: "üí°", status: "locked", desc: "·ª®ng d·ª•ng AI ƒë·ªÉ tƒÉng tr∆∞·ªüng kinh doanh." },
            ],
            categories: [], // S·∫Ω ƒë∆∞·ª£c l·∫•y t·ª´ Firestore
        },

        init() {
            window.fb.onAuthStateChanged(window.fb.fbAuth, async (user) => {
                if (user) {
                    this.store.isLoggedIn = true;
                    this.store.user = { name: user.displayName, trustScore: 450, avatarUrl: user.photoURL };
                    this.store.currentView = 'home';
                    await this.fetchCommunities();
                    this.render();
                } else {
                    this.store.isLoggedIn = false;
                    this.store.currentView = 'auth';
                    this.render();
                }
            });
        },

        async signIn() {
            try {
                const result = await window.fb.signInWithPopup(window.fb.fbAuth, window.fb.googleProvider);
                const user = result.user;
                this.store.isLoggedIn = true;
                this.store.user = { name: user.displayName, trustScore: 450, avatarUrl: user.photoURL };
                this.store.currentView = 'home';
                await this.fetchCommunities();
                this.render();
            } catch (error) {
                console.error("L·ªói ƒëƒÉng nh·∫≠p:", error);
            }
        },

        async fetchCommunities() {
            try {
                const querySnapshot = await window.fb.getDocs(window.fb.collection(window.fb.fbDb, "communities"));
                this.store.categories = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("L·ªói l·∫•y d·ªØ li·ªáu communities:", error);
                this.store.categories = []; // Reset ƒë·ªÉ tr√°nh l·ªói
            }
        },

        navigate(view, data = {}) {
            this.store.currentView = view;
            this.store.currentData = data;
            this.render();
            if (window.innerWidth < 768 && !document.getElementById('sidebar').classList.contains('-translate-x-full')) {
                this.toggleSidebar();
            }
        },

        toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.toggle('hidden');
        },

        render() {
            const container = document.getElementById('app-container');
            if (!this.store.isLoggedIn) {
                container.innerHTML = AppTemplate.auth();
                return;
            }
            if (!document.getElementById('main-app')) {
                container.innerHTML = AppTemplate.main();
            }
            
            const mainContentContainer = document.getElementById('app-content');
            if (!mainContentContainer) return;
            
            // C·∫≠p nh·∫≠t th√¥ng tin user tr√™n sidebar
            document.getElementById('sidebar-username').textContent = this.store.user.name;

            const activeTab = this.store.currentView === 'course_detail' ? 'home' : this.store.currentView;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNavItem = document.querySelector(`.nav-item[data-tab="${activeTab}"]`);
            if(activeNavItem) activeNavItem.classList.add('active');

            const viewRenderer = ViewTemplate[this.store.currentView] || ViewTemplate.home;
            viewRenderer.call(ViewTemplate, mainContentContainer, this.store.currentData);
        }
    };
    
    // G√°n app v√†o window ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ HTML
    window.app = app;

    // Ch·ªù s·ª± ki·ªán 'firebase-ready' r·ªìi m·ªõi kh·ªüi ƒë·ªông app
    document.addEventListener('firebase-ready', () => {
        app.init();
    });
    </script>
</body>
</html>
